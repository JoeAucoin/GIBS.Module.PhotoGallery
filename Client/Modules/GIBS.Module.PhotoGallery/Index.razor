@using GIBS.Module.PhotoGallery.Services
@using GIBS.Module.PhotoGallery.Models
@using System.Text.Json
@using Microsoft.AspNetCore.Components

@namespace GIBS.Module.PhotoGallery
@inherits ModuleBase
@inject IAlbumService AlbumService
@inject IPhotoService PhotoService
@inject ITagService TagService
@inject IPhotoTagService PhotoTagService
@inject NavigationManager NavigationManager
@inject ISettingService SettingService
@inject IStringLocalizer<Index> Localizer

@if (_albumId == -1)
{
    @if (_albums == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="text-end">
            <ActionLink Action="ManageGallery" Security="SecurityAccessLevel.Edit" Text="Manage Gallery" ResourceKey="ManageGallery" />
        </div>
        <br />
        <br />
        @if (_albums.Count != 0)
        {
            <div class="piwigo-gallery" id="piwigoGallery">
                <div class="pw-albums-grid">
                    @foreach (var album in _albums)
                    {
                        <div class="pw-album-card">
                            <div class="pw-album-thumb">
                                <a href="@BuildAlbumUrl(album.AlbumId)">
                                    <img class="pw-album-img" src="@album.ThumbnailPath" alt="@album.AlbumName" loading="lazy" />
                                </a>
                                <div class="pw-album-overlay"></div>
                            </div>
                            <div class="pw-album-info">
                                <h1 class="pw-album-title">
                                    <a href="@BuildAlbumUrl(album.AlbumId)">@album.AlbumName</a>
                                </h1>
                                <span class="pw-album-count">@album.ItemCount photos</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <p>@Localizer["Message.DisplayNone"]</p>
        }
    }
}
else
{
    <div class="container">
        <div class="row">
            <div class="col-md-10">
                <h3>
                    @_selectedAlbumName
                    @if (_items != null && _items.Count > 0)
                    {
                        <a class="ms-3" href="@BuildPhotoUrl(_items.First().PhotoId)" title="Slideshow">
                            <i class="oi oi-play-circle" style="font-size: 1.75rem;"></i>
                        </a>
                        <a class="ms-3" href="@BuildLightboxUrl(_items.First().PhotoId)" title="Lightbox">
                            <i class="oi oi-zoom-in" style="font-size: 1.75rem;"></i>
                        </a>
                    }
                </h3>
            </div>
            <div class="col-md-2 text-end">
                <a href="@NavigateUrl()" class="btn btn-secondary mb-3">Back to Albums</a>
            </div>
        </div>

        @if (_subAlbums != null && _subAlbums.Any())
        {
            <h3 class="pw-subalbums-title">üìÅ Sub-Albums</h3>
            <div class="piwigo-gallery" id="piwigoSubGallery">
                <div class="pw-albums-grid pw-subalbums-grid">
                    @foreach (var album in _subAlbums)
                    {
                        <div class="pw-album-card pw-subalbum-card">
                            <div class="pw-album-thumb">
                                @if (!string.IsNullOrEmpty(album.ThumbnailPath))
                                {
                                    <a href="@BuildAlbumUrl(album.AlbumId)">
                                        <img class="pw-album-img" src="@album.ThumbnailPath" alt="@album.AlbumName" loading="lazy" />
                                    </a>
                                }
                                <div class="pw-album-overlay"></div>
                            </div>
                            <div class="pw-album-info">
                                <h2 class="pw-album-title">
                                    <a href="@BuildAlbumUrl(album.AlbumId)">@album.AlbumName</a>
                                </h2>
                                <span class="pw-album-count">@album.ItemCount photos</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (_albumId != -1 && _tagCounts != null && _tagCounts.Any())
        {
            <div class="container mt-1 mb-3 p-3" style="border: 1px solid #ddd; border-radius: 5px;">
                <div class="row">
                    <div class="col">
                        <span class="fw-bold"><i class="oi oi-tag"></i> Filter by Tag:</span>&nbsp;&nbsp;
                        @foreach (var tag in _tagCounts)
                        {
                            var btnClass = (_selectedTag == tag.Key) ? "btn-primary" : "btn-outline-secondary";
                            <a class="btn btn-sm rounded-pill me-1 mb-1 @btnClass" href="@BuildTagUrl(tag.Key)">
                                @tag.Key (@tag.Value)
                            </a>
                        }
                        &nbsp;
                        @if (!string.IsNullOrEmpty(_selectedTag))
                        {
                            <a class="btn btn-sm btn-link text-danger" href="@BuildAlbumUrl(_albumId)">Clear Filter</a>
                        }
                    </div>
                </div>
            </div>
        }

        @if (_slideshowPhotoId.HasValue)
        {
            var current = _items.FirstOrDefault(i => i.PhotoId == _slideshowPhotoId.Value);
            var currentIndex = current != null ? _items.FindIndex(i => i.PhotoId == current.PhotoId) : -1;
            <div class="text-center mb-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="pw-slideshow-nav">
                        @if (currentIndex > 0)
                        {
                            <a class="pw-slideshow-prev" href="@BuildPhotoUrl(_items[currentIndex - 1].PhotoId)">
                                <i class="oi oi-arrow-circle-left" style="font-size: 32px;"></i>
                            </a>
                        }
                    </div>
                    <div class="flex-grow-1">
                        @if (current != null)
                        {
                            <img src="@current.FilePath" alt="@current.Title" class="border rounded" title="@BuildPhotoTitle(current)" style="max-width: 1000px; max-height: 760px; width: auto; height: auto;" />
                            <h3 class="pw-slideshow-title">@current.Title</h3>
                            @if (!string.IsNullOrEmpty(current.Description))
                            {
                                <div class="pw-slideshow-desc">@current.Description</div>
                            }
                        }
                    </div>
                    <div class="pw-slideshow-nav">
                        @if (currentIndex >= 0 && currentIndex < _items.Count - 1)
                        {
                            <a class="pw-slideshow-next" href="@BuildPhotoUrl(_items[currentIndex + 1].PhotoId)">
                                <i class="oi oi-arrow-circle-right" style="font-size: 32px;"></i>
                            </a>
                        }
                    </div>
                </div>
                <div class="mt-3">
                    <a class="btn btn-secondary" href="@BuildAlbumUrl(_albumId)">Back to Album</a>
                </div>
            </div>
        }
        else
        {
            <h3 class="pw-photos-title">üñºÔ∏è Photos in this Album</h3>
            <div class="pw-photos-grid" id="photosGrid">
                @if (_items == null)
                {
                    <p><em>Loading items...</em></p>
                }
                else
                {
                    @foreach (var item in _items)
                    {
                        <div class="pw-photo-item">
                            <a href="@BuildPhotoUrl(item.PhotoId)">
                                <img src="@item.ThumbnailPath" alt="@item.Title - @item.AlbumName" title="@BuildPhotoTitle(item)" class="pw-photo-img" loading="lazy" />
                            </a>
                            <div class="pw-item-overlay">
                                <div class="pw-item-info">
                                    @if (_showPhotoTitle)
                                    {
                                        <h2 class="pw-item-title">@item.Title</h2>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
}

@if (_showLightbox)
{
    <div class="pw-lightbox-overlay">
        <div class="pw-lightbox-container">
            <a class="pw-lightbox-close" href="@BuildAlbumUrl(_albumId)">&times;</a>

            @if (_items.IndexOf(_selectedItem) > 0)
            {
                <div class="pw-lightbox-nav pw-lightbox-nav-prev">
                    <a class="pw-lightbox-prev" href="@BuildLightboxUrl(_items[_items.IndexOf(_selectedItem) - 1].PhotoId)">
                        <i class="oi oi-arrow-circle-left" style="font-size: 24px;"></i>
                    </a>
                </div>
            }

            <div class="pw-lightbox-content">
                <img src="@_selectedItem.FilePath" alt="@_selectedItem.Title" title="@BuildPhotoTitle(_selectedItem)" />
            </div>

            @if (_items.IndexOf(_selectedItem) < _items.Count - 1)
            {
                <div class="pw-lightbox-nav pw-lightbox-nav-next">
                    <a class="pw-lightbox-next" href="@BuildLightboxUrl(_items[_items.IndexOf(_selectedItem) + 1].PhotoId)">
                        <i class="oi oi-arrow-circle-right" style="font-size: 24px;"></i>
                    </a>
                </div>
            }

            <div class="pw-lightbox-info">
                <h3 class="pw-lightbox-title mt-1">@_selectedItem.Title</h3>
                @if (!string.IsNullOrEmpty(_selectedItem.Description))
                {
                    <div class="pw-lightbox-description">@_selectedItem.Description</div>
                }
                <span class="pw-lightbox-counter">@(_items.IndexOf(_selectedItem) + 1) / @_items.Count</span>
            </div>
        </div>
    </div>
}

@code {
    public override string RenderMode => RenderModes.Static;

    public override List<Resource> Resources => new List<Resource>()
    {
        new Resource { ResourceType = ResourceType.Stylesheet, Url = ModulePath() + "Module.css?v=1.1" }
    };

    private List<PhotoAlbum> _albums;
    private List<PhotoAlbum> _subAlbums;
    private List<Photo> _items;
    private List<Photo> _albumItems;
    private List<Tags> _tags;
    private Dictionary<string, int> _tagCounts;
    private string _selectedTag;
    private int _albumId = -1;
    private int? _slideshowPhotoId;
    private string _selectedAlbumName;
    private string _defaultPageTitle;
    private bool _showLightbox = false;
    private Photo _selectedItem;
    private bool _showPhotoTitle;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _defaultPageTitle = PageState.Page.Title;
            var settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);
            _showPhotoTitle = bool.Parse(SettingService.GetSetting(settings, "ShowPhotoTitle", "true"));
            if (PageState.QueryString.ContainsKey("album") && int.TryParse(PageState.QueryString["album"], out var albumId))
            {
                _albumId = albumId;
                _selectedTag = PageState.QueryString.ContainsKey("tag") ? System.Uri.UnescapeDataString(PageState.QueryString["tag"]) : null;
                await LoadAlbumItems();

                if (PageState.QueryString.ContainsKey("photo") && int.TryParse(PageState.QueryString["photo"], out var photoId))
                {
                    if (PageState.QueryString.ContainsKey("lightbox"))
                    {
                        _showLightbox = true;
                        _selectedItem = _items?.FirstOrDefault(i => i.PhotoId == photoId);
                        if (_selectedItem != null)
                        {
                            SetPageTitle($"{_selectedItem.Title} - {_selectedAlbumName}");
                        }
                    }
                    else
                    {
                        _slideshowPhotoId = photoId;
                    }
                    _selectedItem = _items?.FirstOrDefault(i => i.PhotoId == photoId);
                    if (_selectedItem != null)
                    {
                        SetPageTitle($"{_selectedItem.Title} - {_selectedAlbumName}");

                    }
                }

            }
            else
            {
                _albumId = -1;
                _slideshowPhotoId = null;
                _showLightbox = false;
                _selectedItem = null;
                _selectedTag = null;
                await LoadAlbums();
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Loading Gallery {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.LoadError"], MessageType.Error);
        }
    }

    private string BuildAlbumUrl(int albumId)
    {
        return $"{NavigateUrl()}?album={albumId}#top";
    }

    private string BuildPhotoUrl(int photoId)
    {
        var tagSegment = string.IsNullOrEmpty(_selectedTag) ? string.Empty : $"&tag={System.Uri.EscapeDataString(_selectedTag)}";
        return $"{NavigateUrl()}?album={_albumId}&photo={photoId}{tagSegment}";
    }

    private string BuildLightboxUrl(int photoId)
    {
        var tagSegment = string.IsNullOrEmpty(_selectedTag) ? string.Empty : $"&tag={System.Uri.EscapeDataString(_selectedTag)}";
        return $"{NavigateUrl()}?album={_albumId}&photo={photoId}&lightbox=1{tagSegment}#top";
    }

    private string BuildTagUrl(string tagName)
    {
        var tag = System.Uri.EscapeDataString(tagName);
        return $"{NavigateUrl()}?album={_albumId}&tag={tag}";
    }

    private static string BuildPhotoTitle(Photo photo)
    {
        if (photo == null)
        {
            return string.Empty;
        }

        return string.IsNullOrWhiteSpace(photo.Description)
            ? photo.Title
            : $"{photo.Title} - {photo.Description}";
    }

    private static string BuildAlbumDisplayName(Album album)
    {
        if (album == null)
        {
            return "Album";
        }

        return string.IsNullOrWhiteSpace(album.Description)
            ? album.AlbumName
            : $"{album.AlbumName} - {album.Description}";
    }

    private async Task LoadAlbums()
    {
        _albums = await PhotoService.GetPhotoAlbumsAsync(ModuleState.ModuleId);
        var albumEntities = await AlbumService.GetAlbumsAsync(ModuleState.ModuleId);
        var topLevelAlbumIds = albumEntities.Where(a => a.ParentAlbumId == null).Select(a => a.AlbumId).ToHashSet();
        _albums = _albums.Where(a => topLevelAlbumIds.Contains(a.AlbumId)).ToList();
        _subAlbums = null;
    }

    private async Task LoadTags()
    {
        _tags = await TagService.GetTagsAsync(ModuleState.ModuleId);
    }

    private async Task LoadAlbumItems()
    {
        var allItems = await PhotoService.GetPhotosAsync(ModuleState.ModuleId);
        var albumEntities = await AlbumService.GetAlbumsAsync(ModuleState.ModuleId);
        var albumLookup = albumEntities.ToDictionary(a => a.AlbumId, a => a);

        _albumItems = allItems.Where(i => i.AlbumId == _albumId).OrderBy(i => i.SortOrder).ToList();
        if (_albumItems.Any())
        {
            var selectedAlbum = albumEntities.FirstOrDefault(a => a.AlbumId == _albumId);

            _selectedAlbumName = BuildAlbumDisplayName(selectedAlbum);  // selectedAlbum?.AlbumName ?? "Album";
            SetPageTitle(BuildAlbumDisplayName(selectedAlbum));
            await LoadTags();
            if (_tags != null)
            {
                foreach (var item in _albumItems)
                {
                    if (item.AlbumId.HasValue && albumLookup.TryGetValue(item.AlbumId.Value, out var album))
                    {
                        item.AlbumName = album.AlbumName;
                    }

                    var itemTags = await PhotoTagService.GetPhotoTagsAsync(item.PhotoId, ModuleState.ModuleId);
                    if (itemTags != null && itemTags.Any())
                    {
                        var tagNames = new List<string>();
                        foreach (var itemTag in itemTags)
                        {
                            var tag = _tags.FirstOrDefault(t => t.TagId == itemTag.TagId);
                            if (tag != null)
                            {
                                tagNames.Add(tag.TagName);
                            }
                        }
                        item.Tags = string.Join(", ", tagNames);
                    }
                }
            }

            _tagCounts = _albumItems
                .Where(i => !string.IsNullOrEmpty(i.Tags))
                .SelectMany(i => i.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries).Select(t => t.Trim()))
                .GroupBy(t => t)
                .OrderBy(g => g.Key)
                .ToDictionary(g => g.Key, g => g.Count());
        }
        else
        {
            var selectedAlbum = albumEntities.FirstOrDefault(a => a.AlbumId == _albumId);
            _selectedAlbumName = selectedAlbum?.AlbumName ?? "Album";
            _albumItems = new List<Photo>();
            _tagCounts = new Dictionary<string, int>();
        }

        var childAlbums = albumEntities.Where(a => a.ParentAlbumId == _albumId && a.IsActive).ToList();
        _subAlbums = childAlbums
            .Select(album =>
            {
                var items = allItems.Where(i => i.AlbumId == album.AlbumId).OrderBy(i => i.SortOrder).ThenBy(i => i.PhotoId).ToList();
                var firstItem = items.FirstOrDefault();
                return new PhotoAlbum
                {
                    AlbumId = album.AlbumId,
                    AlbumName = album.AlbumName,
                    ItemCount = items.Count,
                    ThumbnailPath = firstItem?.ThumbnailPath ?? firstItem?.FilePath
                };
            })
            .ToList();

        _items = new List<Photo>(_albumItems);
        ApplyTagFilter();
    }

    private void ApplyTagFilter()
    {
        if (string.IsNullOrEmpty(_selectedTag))
        {
            return;
        }

        _items = _albumItems.Where(i =>
            !string.IsNullOrEmpty(i.Tags) &&
            i.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                  .Select(t => t.Trim())
                  .Contains(_selectedTag))
            .ToList();
    }

    private async Task FilterByTag(string tagName)
    {
        if (_selectedTag == tagName)
        {
            ClearTagFilter();
        }
        else
        {
            _selectedTag = tagName;
            _items = _albumItems.Where(i =>
                !string.IsNullOrEmpty(i.Tags) &&
                i.Tags.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                      .Select(t => t.Trim())
                      .Contains(_selectedTag))
                .ToList();
        }
        StateHasChanged();
    }

    private void ClearTagFilter()
    {
        _selectedTag = null;
        _items = new List<Photo>(_albumItems);
        StateHasChanged();
    }

    private async Task ViewAlbum(int albumId)
    {
        _albumId = albumId;
        await LoadAlbumItems();
        StateHasChanged();
    }



    private void OpenLightbox(Photo item)
    {
        _selectedItem = item;
        _showLightbox = true;
        StateHasChanged();
    }

    private async Task OpenLightboxAsync(int photoId)
    {
        if (_items == null)
        {
            return;
        }

        var item = _items.FirstOrDefault(i => i.PhotoId == photoId);
        if (item == null)
        {
            return;
        }

        OpenLightbox(item);
        await Task.CompletedTask;
    }

    private void CloseLightbox()
    {
        _showLightbox = false;
        _selectedItem = null;
        StateHasChanged();
    }

    private void ShowNext()
    {
        int currentIndex = _items.FindIndex(i => i.PhotoId == _selectedItem.PhotoId);
        if (currentIndex < _items.Count - 1)
        {
            _selectedItem = _items[currentIndex + 1];
            SetPageTitle($"{_selectedItem.Title} - {_selectedAlbumName}");
            StateHasChanged();
        }
    }

    private void ShowPrevious()
    {
        int currentIndex = _items.FindIndex(i => i.PhotoId == _selectedItem.PhotoId);
        if (currentIndex > 0)
        {
            _selectedItem = _items[currentIndex - 1];
            SetPageTitle($"{_selectedItem.Title} - {_selectedAlbumName}");
            StateHasChanged();
        }
    }
}